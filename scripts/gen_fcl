#!/bin/bash 
#------------------------------------------------------------------------------
# example:
# --------
#    gen_fcl mdc2018_stntuple 721_0001 flateminus-mix:0001  read_reco_stn 1 .
# 
#------------------------------------------------------------------------------

    project=$1                # mdc2018_stntuple
    version=$2                # 721_0001
       fsid=$3                # flateminus.0001 (dsid:fileset)
        job=$4                # read_reco_stn
       doit=$5

       dsid=`echo $fsid | awk -F: '{print $1}'`
         fs=`echo $fsid | awk -F: '{print $2}'`
    dataset=`cat $project/AAA_PROJECT.txt | awk -v v=$version -v d=$dsid '{ if (($1 == v) && ($2 == d)) print $3; }'`
      merge=`cat $project/AAA_PROJECT.txt | awk -v v=$version -v d=$dsid '{ if (($1 == v) && ($2 == d)) print $4; }'`

prefix='echo ' ; if [ ".$doit" != "." ] ; then prefix='' ; fi

if [ ".$doit" == ".-v" ] ; then 
    echo project=$project
    echo version=$version
    echo fsid=$fsid
    echo job=$job
    echo merge=$merge
    echo dsid=$dsid
    echo fs=$fs
    echo dataset=$dataset
#    exit
fi

setup mu2etools
setup mu2efiletools
setup mu2egrid 

catalog_dir=/grid/fermiapp/mu2e/catalogs/MDC2018

fs_stub=""
if [ ".$fs" != "," ] ; then fs_stub=".$fs" ; fi

 input_files=$catalog_dir/$dataset/$dataset${fs_stub}.files
template_fcl=$project/$version/${job}.${dsid}.fcl

if [ -d 000 ] ; then rm -rf 000 ; fi

$prefix generate_fcl --description=$job --dsconf=$dsid \
                     --embed $template_fcl \
                     --merge=$merge \
                     --inputs=$input_files

echo checkpoint 001 : FCLs generated by `which generate_fcl`

mv seeds.murat* 000/.

echo checkpoint 002 : seeds moved to ./000/.

merge_stub=`printf "%04i" $merge`;

fcl_dir=$project/tmp_fcl/$dataset${fs_stub}.$job.$merge_stub

if [ -d  $fcl_dir ] ; then rm -rf $fcl_dir ; fi
mv 000 $fcl_dir
cd $fcl_dir

echo checkpoint 003 : ./000 moved to $fcl_dir

# assume fileset to be 6-character long
if [ ".$fs" != "." ] ; then fcl_tarfile=$project.$version.$dsid.$fs.$job.$merge_stub.fcl.tbz
else                        fcl_tarfile=$project.$version.$dsid.$job.$merge_stub.fcl.tbz
fi

$prefix tar -cjf ../$fcl_tarfile *.fcl

echo checkpoint 004 : ../$fcl_tarfile created

if [ -f /pnfs/mu2e/resilient/users/murat/$fcl_tarfile ] ; then rm /pnfs/mu2e/resilient/users/murat/$fcl_tarfile ; fi

$prefix cp  ../$fcl_tarfile /pnfs/mu2e/resilient/users/murat/.

echo checkpoint 005 : ../$fcl_tarfile moved to /pnfs/mu2e/resilient/users/murat/.

